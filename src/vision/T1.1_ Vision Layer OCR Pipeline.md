# T1.1 – Vision Layer: OCR Pipeline (Production Ready)

## Overview

This document describes the complete implementation of **T1.1 – OCR Pipeline** for Phase 1 (Vision Layer).  
The objective of T1.1 was to build a **robust, configurable, and extensible OCR pipeline** using **Docling** as the primary engine, with **Tesseract** and **TrOCR** added for comparison.

The task focused strictly on:
- OCR engine wrappers
- CLI tooling
- Error handling and robustness
- Engine isolation and comparison readiness

**Accuracy validation and benchmarking are explicitly deferred to T1.4.**

---

## Final Status

**Status:** ✅ COMPLETE  
**Phase:** Phase 1 – Vision Layer  
**Task:** T1.1 OCR Pipeline  

---

## Folder Structure

src/
└── vision/
└── ocr/
├── run_ocr.py              # Main CLI entrypoint
├── engines/
│   ├── base.py             # Shared engine interface
│   ├── docling_engine.py   # Primary OCR engine (Docling)
│   ├── tesseract_engine.py # Baseline OCR engine (Tesseract)
│   └── trocr_engine.py     # Experimental OCR engine (TrOCR)
└── metrics/
└── accuracy.py             # CER / WER / Character accuracy utilities

data/
└── benchmarks/
    └── pubmed_ocr/
        ├── *.pdf
        └── *_gt.json

Each OCR engine is **isolated**, **interchangeable**, and **CLI-selectable**.

---

## run_ocr.py — Main CLI Entrypoint

### Purpose

`run_ocr.py` is the **single command-line interface** for executing OCR across all supported engines.

It is responsible for:
- Parsing CLI arguments
- Selecting the OCR engine
- Mapping strategy flags (speed vs accuracy)
- Handling progress callbacks
- Emitting OCR outputs
- Optionally computing accuracy metrics

### Supported CLI Flags

--engine docling | tesseract | trocr
--strategy fast | accurate
--output-format text | markdown | json
--ground_truth path/to/gt.json (optional)
--output path/to/output (optional)


---

## engines/base.py — Shared Engine Interface

### Purpose

Defines a common contract so all OCR engines behave consistently.

### Guarantees

All engines:
- Accept flexible constructor arguments
- Implement `process_pdf`
- Return a standardized result dictionary

---

## engines/docling_engine.py — Primary OCR Engine (Docling)

### Purpose

Implements the main production OCR pipeline using Docling.

### Why Docling

- High-quality OCR
- Native table structure extraction
- Layout-aware document processing
- Fully offline execution (no cloud dependency)

### Configuration Highlights

- OCR enabled
- Table structure extraction enabled
- Cell matching enabled
- Remote services disabled

---

### Corrupted PDF Handling (Critical)

Before OCR starts:
- PDF existence is checked
- PDF integrity is validated using `PyPDF2`

If the PDF is corrupted:
- OCR **does not crash**
- A structured failure response is returned

Example failure response:
{
"success": false,
"error": "Invalid or corrupted PDF",
"pdf": "path/to/file.pdf"
}



---

### Large PDF Handling (100+ Pages)

Docling has been validated on **100+ page PDFs**:
- Sequential page processing
- Stable memory usage
- No deadlocks or memory leaks
- Linear runtime scaling
- Page count and total runtime reported

Example success response:
{
"success": true,
"text": "...",
"markdown": "...",
"pages": 100,
"time_sec": 42.7
}



Docling is considered **production-ready for large documents**.

---

## engines/tesseract_engine.py — Baseline OCR Engine (Tesseract)

### Purpose

Provides a fast, classical OCR baseline for comparison.

### Why Tesseract

- Lightweight
- CPU-only
- Widely used
- Strong baseline for printed text

### Binary Resolution (Hardcoding Removed)

The Tesseract binary is resolved in the following order:
1. `TESSERACT_PATH` environment variable
2. System PATH (`shutil.which("tesseract")`)
3. Windows fallback:

If not found, a clear error is raised:
Tesseract not found. Please install it and add it to PATH.


---

### Corrupted & Large PDF Handling

- Corrupted PDFs fail early during rasterization (Poppler)
- Errors are caught by the CLI and reported cleanly
- No crashes or undefined states

Large PDFs:
- Page-by-page rasterization
- Stable but slower than Docling
- Higher memory usage (expected)

Tesseract is suitable as a **baseline engine**, not for layout-critical tasks.

---

## engines/trocr_engine.py — Experimental OCR Engine (TrOCR)

### Purpose

Included for experimentation and extensibility testing.

### Role in T1.1

- Validates engine isolation
- Demonstrates future extensibility
- Not used as a production OCR engine

### Known Limitations

- Slow on full-page PDFs
- No layout reconstruction
- Best suited for cropped or line-level OCR

---

## metrics/accuracy.py — OCR Accuracy Utilities

### Purpose

Provides standard OCR evaluation metrics.

### Metrics Implemented

- Character Error Rate (CER)
- Word Error Rate (WER)
- Character-level accuracy

### Notes

- Metrics are optional
- Only computed when `--ground_truth` is provided
- Formally enforced in **T1.4**, not T1.1

---

## System Dependencies (Windows)

### Tesseract-OCR

Download:  
https://github.com/UB-Mannheim/tesseract/wiki

Verify:
tesseract --version

---

### Poppler (PDF Rasterization)

Download:  
https://github.com/oschwartz10612/poppler-windows/releases

Add to PATH:
C:\Program Files\poppler\Library\bin

Verify:
pdfinfo -v

---

## Dataset Preparation (Reference for T1.4)

Dataset preprocessing is **not part of T1.1 execution**.  
It is documented for completeness and used in **T1.4**.

Some datasets are distributed as Parquet-only and must be converted to:
.parquet → PDF + Ground Truth JSON

### Expected Ground Truth Format

{
"ocr": {
"text": {
"lines": [
{"text": "First line"},
{"text": "Second line"}
]
}
}
}

---

## T1.1 Validation Checklist

Completed:

- ✅ Valid PDF processing
- ✅ Corrupted PDF graceful failure
- ✅ 100+ page PDF stability
- ✅ Engine switching (Docling / Tesseract / TrOCR)
- ✅ CLI output formats
- ✅ Progress reporting
- ✅ No hardcoded system paths

**Accuracy benchmarking is completed in T1.4.**

---

## Final Note

T1.1 establishes a **stable, deployment-ready OCR foundation**.

The system is now ready for:
➡ **T1.4 – Base Engine Validation**  
➡ **Phase 2 – Real-World Adaptation**
